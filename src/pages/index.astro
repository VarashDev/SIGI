---
// @ts-nocheck
import Layout from "../layouts/Layout.astro";
import AddRecordForm from "../components/AddRecordForm.astro";
import TodaysRecords from "../components/TodaysRecords.astro";

import { SignedIn, SignedOut, UserButton, SignInButton } from '@clerk/astro/components'

import { db, Record, desc, sql, like } from 'astro:db';
import { eq, and } from 'drizzle-orm';

const uaDate = new Date().toLocaleDateString("uk-UA", {
  timeZone: "Europe/Kyiv",
  dateStyle: "long",
});

const { userId } = Astro.locals.auth()

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const reason = formData.get('reason');
  const recorded = new Date();
  if (typeof reason === 'string') {
    // Insert form data into the Comment table
    await db.insert(Record).values({ reason, recorded, userId });
  }
}

const todaysRecords = await db
  .select()
  .from(Record)
  .where(and(like(Record.userId, userId), 
eq(
      sql`date(${Record.recorded}, '+3 hours')`,
      sql`date('now', '+3 hours')`
    )
  )
    
  )
  .orderBy(desc(Record.id));

const todaysCount = todaysRecords.length;


---
<Layout
title="Sigi"
>

<SignedIn>

  <AddRecordForm />

<h1 class="text-xl font-semibold m-4">{uaDate}</h1>
<!-- <h2 class="text-2xl font-black m-4">Today: {todaysCount}</h2>

<table class="min-w-full border border-gray-200 divide-y divide-gray-200 shadow">
  <thead class="bg-amber-200">
    <tr>
      <th class="w-24 px-4 py-2 text-left text-sm font-semibold text-gray-700">Time</th>
      <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Reason</th>
    </tr>
  </thead>
  <tbody class="divide-y divide-gray-200">
    {todaysRecords.map((record, idx) => (
      <tr class={idx % 2 === 0 ? "bg-white" : "bg-gray-50"}>
        <td class="w-24 px-4 py-2 text-sm text-gray-800">
          {record.recorded.toLocaleTimeString("uk-UA", {
            timeZone: "Europe/Kyiv",
            hour: "2-digit",
            minute: "2-digit",
          })}
        </td>
        <td class="px-4 py-2 text-sm text-gray-800">{record.reason}</td>
      </tr>
    ))}
  </tbody>
</table> -->

    <!-- Render the table server-side, deferred -->
    <TodaysRecords server:defer todaysRecords={todaysRecords} todaysCount={todaysCount} />

</SignedIn>
<SignedOut>
  You should be logged in.
</SignedOut>
</Layout>